<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iPAS AIæ‡‰ç”¨è¦åŠƒå¸« è¼”åŠ©å°å¤©ä½¿ pre-1.2 ç‰ˆ By Force Cheng åŸåŠ›ç‹ è€å¸«</title>
    <!-- å¼•å…¥ PapaParse ç”¨æ–¼è§£æ CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        /* --- Google Fonts & Variables --- */
        :root {
            --google-blue: #4285F4;
            --google-red: #EA4335;
            --google-yellow: #FBBC05;
            --google-green: #34A853;
            --gray-100: #f1f3f4;
            --gray-300: #dadce0;
            --gray-800: #202124;
            --shadow-1: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        body { margin: 0; background-color: var(--gray-100); color: var(--gray-800); padding-bottom: 80px; }

        /* --- Components --- */
        .container { max-width: 800px; margin: 0 auto; padding: 16px; }
        .hidden { display: none !important; }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 20px;
        }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--google-blue);
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Buttons */
        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 10px 24px; border-radius: 4px; border: none; cursor: pointer;
            font-size: 16px; font-weight: 500; transition: background 0.2s;
            text-decoration: none; user-select: none;
        }
        .btn-sm { padding: 6px 12px; font-size: 14px; }
        .btn-primary { background-color: var(--google-blue); color: white; box-shadow: var(--shadow-1); }
        .btn-primary:active { transform: translateY(1px); }
        .btn-outline { background-color: white; border: 1px solid var(--gray-300); color: var(--google-blue); }
        .btn-danger-outline { background-color: white; border: 1px solid var(--google-red); color: var(--google-red); }
        .btn-danger-outline:hover { background-color: #fce8e6; }
        .btn-dark-outline { background-color: white; border: 1px solid #5f6368; color: #5f6368; }
        .btn-dark-outline:hover { background-color: #f1f3f4; }
        .btn-block { width: 100%; }
        .btn-lg { padding: 16px; font-size: 18px; }

        /* Inputs */
        .form-group { margin-bottom: 16px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; color: #5f6368; }
        select, input[type="number"] {
            width: 100%; padding: 12px; border: 1px solid var(--gray-300);
            border-radius: 4px; font-size: 16px; background: white;
        }

        /* Cards */
        .card {
            background: white; border-radius: 8px; padding: 24px;
            margin-bottom: 16px; box-shadow: var(--shadow-1);
        }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .badge {
            padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;
            background: var(--gray-300); color: #555;
        }
        .badge-subject { background: #e8f0fe; color: var(--google-blue); }
        .badge-id { background: #fce8e6; color: var(--google-red); }

        /* Review Card Style */
        .review-card {
            background: white; border-radius: 8px; padding: 20px;
            margin-bottom: 16px; box-shadow: var(--shadow-1);
            border-left: 5px solid var(--google-red); /* Red indicator for wrong answers */
        }

        /* Navigation */
        header { background: white; box-shadow: var(--shadow-1); position: sticky; top: 0; z-index: 100; }
        .nav-bar { display: flex; max-width: 800px; margin: 0 auto; }
        .nav-item {
            flex: 1; text-align: center; padding: 16px; cursor: pointer;
            font-weight: 500; color: #5f6368; border-bottom: 3px solid transparent;
        }
        .nav-item.active { color: var(--google-blue); border-bottom-color: var(--google-blue); }

        /* Question Styles */
        .question-text { font-size: 18px; line-height: 1.5; margin-bottom: 20px; font-weight: 500; }
        .options-grid { display: grid; gap: 12px; }
        .option-btn {
            width: 100%; text-align: left; padding: 16px; border: 2px solid var(--gray-300);
            border-radius: 8px; background: white; cursor: pointer; font-size: 16px;
            transition: all 0.2s; position: relative;
        }
        .option-btn:hover { border-color: var(--google-blue); background: #f8f9fa; }
        .option-btn.selected { border-color: var(--google-blue); background: #e8f0fe; color: var(--google-blue); font-weight: bold; }
        
        /* Feedback & Review Styles */
        .option-btn.correct { border-color: var(--google-green); background: #e6f4ea; color: #0d652d; font-weight: bold; }
        .option-btn.wrong { border-color: var(--google-red); background: #fce8e6; color: #c5221f; text-decoration: line-through; opacity: 0.8; }
        
        /* For Browse Mode Answers */
        .browse-opt { padding: 10px; border-radius: 4px; margin-bottom: 8px; border: 1px solid #ddd; background: #f8f9fa; }
        .browse-opt.is-ans { border-color: var(--google-green); background: #e6f4ea; color: #0d652d; font-weight: bold; }

        /* Feedback Panel */
        .feedback-panel {
            margin-top: 16px; padding: 16px; border-radius: 8px; background: #f1f3f4; border-left: 5px solid var(--google-blue);
        }
        .feedback-panel.correct { border-left-color: var(--google-green); background: #e6f4ea; }
        .feedback-panel.wrong { border-left-color: var(--google-red); background: #fce8e6; }
        .source-text { font-size: 12px; color: #5f6368; margin-top: 8px; }

        /* Keyboard Hint */
        .keyboard-hint {
            text-align: center; margin-top: 12px; font-size: 13px; color: #666;
            display: flex; justify-content: center; align-items: center; gap: 15px;
        }
        .key-badge {
            display: inline-block; padding: 2px 8px; border: 1px solid #ccc; border-radius: 4px; border-bottom-width: 2px;
            background: #f8f9fa; font-family: monospace; font-weight: bold; font-size: 12px; color: #333;
        }
        /* Mobile optimization: hide hints on small screens */
        @media (max-width: 600px) {
            .keyboard-hint { display: none; }
        }

        /* Result View */
        .score-circle {
            width: 120px; height: 120px; border-radius: 50%; border: 8px solid var(--google-blue);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            margin: 0 auto 16px; font-size: 32px; font-weight: bold; color: var(--google-blue);
        }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; text-align: center; }
        .stat-box { padding: 12px; border-radius: 8px; background: white; box-shadow: var(--shadow-1); }
        .stat-value { font-size: 20px; font-weight: bold; }

        /* Footer */
        footer {
            margin-top: 40px; padding: 20px; background: white; border-top: 1px solid var(--gray-300);
            font-size: 12px; color: #5f6368; text-align: center;
        }
        .footer-link { color: var(--google-blue); text-decoration: none; font-weight: bold; }
        .footer-link:hover { text-decoration: underline; }

        /* Footer Details */
        footer details {
            margin-top: 0px;
        }
        footer summary {
            cursor: pointer;
            color: #5f6368;
            font-size: 13px;
            font-weight: 500;
            user-select: none;
            outline: none;
            text-align: center;
            list-style: none; /* æ¨™æº–éš±è—ä¸‰è§’å½¢ */
        }
        footer summary::-webkit-details-marker {
            display: none; /* Chrome éš±è—ä¸‰è§’å½¢ */
        }
        footer summary:hover {
            color: var(--google-blue);
            text-decoration: underline;
        }
        /* è‡ªå®šç¾©å±•é–‹æŒ‡ç¤ºç¬¦ */
        footer summary::after {
            content: " â–¼";
            font-size: 0.8em;
            vertical-align: middle;
        }
        footer details[open] summary::after {
            content: " â–²";
        }
        footer .license-text {
            text-align: left;
            font-size: 13px;
            color: #5f6368;
            line-height: 1.8;
            margin-top: 15px;
            padding: 20px;
            background: #fff;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            white-space: pre-line; /* ä¿ç•™ç”¨æˆ¶çš„æ›è¡Œæ ¼å¼ */
        }

        /* --- PRINT STYLES --- */
        .print-only-footer { display: none; }
        
        @media print {
            body { background: white; color: black; }
            
            /* Hide non-printable elements */
            header, .nav-bar, #loading-overlay, #view-browse, #view-setup, #view-exam {
                display: none !important;
            }
            
            /* Hide buttons inside the result view */
            #view-result .btn, footer details {
                display: none !important;
            }

            /* Ensure result view is visible */
            #app, #view-result {
                display: block !important;
                visibility: visible;
                width: 100%;
                margin: 0;
                padding: 0;
            }

            /* Ensure cards look good in print (remove shadows if needed, simplify) */
            .card, .review-card {
                box-shadow: none;
                border: 1px solid #ddd;
                page-break-inside: avoid;
            }

            /* Special Print Footer */
            .print-only-footer {
                display: block !important;
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                text-align: center;
                background: white;
                padding: 10px;
                border-top: 2px solid var(--google-blue);
                font-size: 12px;
                color: #333;
                font-weight: bold;
            }
            
            /* Adjust content spacing so it doesn't overlap footer */
            body { padding-bottom: 50px; }
        }
    </style>
</head>
<body>

<!-- Print Footer (Visible only in Print Mode) -->
<div class="print-only-footer">
    iPAS AIæ‡‰ç”¨è¦åŠƒå¸« æ¨¡æ“¬æ¸¬è©¦çµæœï½œä»‹é¢èˆ‡ç³»çµ±ç¤ºç¯„ï¼šForce Cheng åŸåŠ›ç‹ è€å¸«
</div>

<!-- Loading Overlay -->
<div id="loading-overlay">
    <div class="spinner"></div>
    <p style="margin-top: 16px; font-weight: bold; color: #555;">æ­£åœ¨é€£ç·šè‡³ Google é¡Œåº«...</p>
    <p style="font-size: 12px; color: #999;">(è«‹ä¿æŒç¶²è·¯é€£ç·š)</p>
</div>

<header>
    <div style="padding: 16px; text-align: center; border-bottom: 1px solid #eee;">
        <h2 style="margin:0; color: var(--google-blue);">iPAS AIæ‡‰ç”¨è¦åŠƒå¸« è¼”åŠ©å°å¤©ä½¿ pre-1.2 ç‰ˆ</h2>
        <div style="margin-top: 4px;">
            <small style="color: #666; font-weight: bold;">By Force Cheng åŸåŠ›ç‹ è€å¸« (2025.12.29)</small>
        </div>
        <div style="margin-top: 8px; font-size: 12px;">
            <a href="https://www.ipas.org.tw/certification/AIAP/learning-resources" target="_blank" style="color: var(--google-blue); text-decoration: none;">
                ğŸ”— å®˜æ–¹æ­·å²è€ƒé¡Œè³‡æ–™ä¾†æº
            </a>
        </div>
    </div>
    <div class="nav-bar">
        <div class="nav-item active" onclick="app.switchMode('browse')">é¡Œåº«é–±è¦½</div>
        <div class="nav-item" onclick="app.switchMode('setup')">æ¨¡æ“¬æ¸¬é©—</div>
    </div>
</header>

<div id="app" class="container hidden">
    <!-- View: Browse -->
    <div id="view-browse">
        <div class="card">
            <div class="form-group">
                <label>é¸æ“‡ç§‘ç›®</label>
                <select id="browse-subject" onchange="app.filterBrowseData(true)">
                    <option value="ALL">å…¨éƒ¨ç§‘ç›®</option>
                    <option value="A1">A1 - äººå·¥æ™ºæ…§åŸºç¤æ¦‚è«–</option>
                    <option value="A2">A2 - æ³•å¾‹èˆ‡è¦ç¯„</option>
                    <option value="B1">B1 - æ©Ÿå™¨å­¸ç¿’</option>
                    <option value="B2">B2 - æ·±åº¦å­¸ç¿’</option>
                    <option value="B3">B3 - æŠ€è¡“èˆ‡æ‡‰ç”¨</option>
                </select>
            </div>
            <div class="stat-grid">
                <div class="form-group" style="margin:0;">
                    <label>æ’åº</label>
                    <select id="browse-order" onchange="app.filterBrowseData(true)">
                        <option value="seq">é †åº</option>
                        <option value="rand">éš¨æ©Ÿ</option>
                    </select>
                </div>
                <div class="form-group" style="margin:0; display:flex; align-items:center;">
                   <label style="margin:0; cursor: pointer;">
                        <input type="checkbox" id="browse-show-ans" onchange="app.renderBrowseChunk()"> å…¨éƒ¨é¡¯ç¤ºç­”æ¡ˆ
                    </label>
                </div>
            </div>
            <div style="margin-top:10px; text-align:right;">
                <span id="browse-count" class="badge">å…± 0 é¡Œ</span>
            </div>
        </div>
        <div id="browse-list">
            <!-- Dynamic Content -->
        </div>
        <button id="btn-load-more" class="btn btn-outline btn-block hidden" onclick="app.renderBrowseChunk()">
            è¼‰å…¥æ›´å¤šé¡Œç›®...
        </button>
    </div>

    <!-- View: Exam Setup -->
    <div id="view-setup" class="hidden">
        <div class="card">
            <h3 style="text-align: center; margin-top: 0;">æ¸¬é©—è¨­å®š</h3>
            <div class="form-group">
                <label>æ¸¬é©—ç§‘ç›®</label>
                <select id="exam-subject">
                    <option value="ALL">å…¨éƒ¨ç§‘ç›® (ç¶œåˆæ¸¬é©—)</option>
                    <option value="A1">A1</option>
                    <option value="A2">A2</option>
                    <option value="B1">B1</option>
                    <option value="B2">B2</option>
                    <option value="B3">B3</option>
                </select>
            </div>
            <div class="form-group">
                <label>å‡ºé¡Œé †åº</label>
                <select id="exam-order">
                    <option value="rand">éš¨æ©Ÿå‡ºé¡Œ (æ¨¡æ“¬è€ƒæ¨¡å¼)</option>
                    <option value="seq">ä¾é¡Œè™Ÿé †åº</option>
                </select>
            </div>
            <div class="form-group">
                <label>æ¸¬é©—é¡Œæ•¸</label>
                <input type="number" id="exam-limit" value="50" min="5" max="250">
            </div>
            <button class="btn btn-primary btn-block btn-lg" onclick="app.startExam()">é–‹å§‹æ¸¬é©—</button>
        </div>
    </div>

    <!-- View: Exam Running -->
    <div id="view-exam" class="hidden">
        <div style="display:flex; justify-content:space-between; background:var(--google-blue); color:white; padding:8px 16px; border-radius:8px 8px 0 0; font-weight:bold; font-size:14px;">
            <span id="exam-header-info">ç¶œåˆ / éš¨æ©Ÿ</span>
            <span id="exam-score-info">å¾—åˆ†: 0</span>
        </div>
        <div class="card" style="border-radius: 0 0 8px 8px;">
            <div class="card-header">
                <span class="badge badge-id" id="exam-q-id">ID: --</span>
                <span style="font-weight: bold; color: #5f6368;" id="exam-progress">1 / 50</span>
            </div>
            <div class="question-text" id="exam-q-text">é¡Œç›®è¼‰å…¥ä¸­...</div>
            <div class="options-grid" id="exam-options"></div>
            
            <!-- Feedback Section -->
            <div id="exam-feedback" class="hidden">
                <div id="feedback-panel" class="feedback-panel">
                    <div id="feedback-msg" style="font-weight: bold; font-size: 16px; margin-bottom: 4px;"></div>
                    <div id="feedback-detail"></div>
                </div>
                <div class="source-text" id="feedback-source"></div>
                <button class="btn btn-primary btn-block" style="margin-top: 16px;" onclick="app.nextQuestion()">ä¸‹ä¸€é¡Œ</button>
            </div>

            <!-- Submit Button -->
            <button id="exam-submit-btn" class="btn btn-primary btn-block hidden" style="margin-top: 16px;" onclick="app.submitAnswer()">é€å‡ºç­”æ¡ˆ</button>

            <!-- Keyboard Hint -->
            <div class="keyboard-hint">
                <div><span class="key-badge">1</span>-<span class="key-badge">4</span> é¸æ“‡ç­”æ¡ˆ</div>
                <div><span class="key-badge">Enter</span> é€å‡º / ä¸‹ä¸€é¡Œ</div>
            </div>
        </div>
    </div>

    <!-- View: Result -->
    <div id="view-result" class="hidden">
        <div class="card">
            <h3 style="text-align: center; margin-top: 0;">æ¸¬é©—çµæŸ</h3>
            <div class="score-circle">
                <span id="result-score">0</span>
                <span style="font-size: 14px; font-weight: normal;">ç¸½åˆ†</span>
            </div>
            
            <div class="stat-grid">
                <div class="stat-box">
                    <div class="stat-label">ç­”å°</div>
                    <div class="stat-value" style="color: var(--google-green);" id="result-correct">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">ç­”éŒ¯</div>
                    <div class="stat-value" style="color: var(--google-red);" id="result-wrong">0</div>
                </div>
            </div>

            <div style="margin-top: 24px; gap: 10px; display: grid;">
                <button class="btn btn-primary btn-block" onclick="app.switchMode('setup')">é‡æ–°æ¸¬é©—</button>
                <button class="btn btn-outline btn-block" onclick="app.switchMode('browse')">å›åˆ°é¡Œåº«</button>
            </div>
        </div>

        <!-- Wrong Questions Review Section -->
        <div id="review-section" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:flex-end; margin: 30px 0 15px;">
                <h3 style="color: #666; margin:0;">âŒ éŒ¯é¡Œå›é¡§</h3>
                <div style="display:flex; gap:10px;">
                    <!-- New Print Button -->
                    <button class="btn btn-sm btn-dark-outline" onclick="app.printResults()">ğŸ–¨ï¸ åˆ—å° / å­˜ç‚º PDF</button>
                    <button class="btn btn-sm btn-danger-outline" onclick="app.downloadMistakesCSV()">ğŸ“¥ ä¸‹è¼‰ CSV</button>
                </div>
            </div>
            <div id="review-list"></div>
        </div>
    </div>
</div>

<footer>
    <div style="max-width: 800px; margin: 0 auto;">
        <details>
            <summary>ç‰ˆæ¬Šèˆ‡ä½¿ç”¨è²æ˜ï½œCopyright & Educational Use Notice</summary>
            <div class="license-text">
ä¸­æ–‡ç‰ˆ
ã€ç‰ˆæ¬Šèˆ‡ä½¿ç”¨è²æ˜ã€‘

æœ¬ç¶²ç«™åƒ…ä½œç‚º AI æ‡‰ç”¨è¦åŠƒã€æ•™å­¸ç¤ºç¯„èˆ‡æ¸¬è©¦ç”¨é€”ï¼Œ
ç”¨ä»¥å±•ç¤ºé¡Œåº«è³‡æ–™åœ¨ä¸åŒäº’å‹•ä»‹é¢ã€é–±è®€æ¨¡å¼èˆ‡æ¨¡æ“¬è€ƒè©¦æµç¨‹ä¸‹çš„æ‡‰ç”¨æ–¹å¼ã€‚

æœ¬ç¶²ç«™æ‰€ä½¿ç”¨ä¹‹é¡Œç›®å…§å®¹ï¼Œå…¶åŸå§‹è³‡æ–™ä¾†æºå±¬æ–¼ iPAS å®˜æ–¹å…¬é–‹ä¹‹ç•¶æ¬¡è©¦é¡Œï¼é¡Œåº«å…¬å‘Šï¼Œ
ç›¸é—œè‘—ä½œæ¬Šèˆ‡ä¸€åˆ‡æ¬Šåˆ©å‡æ­¸åŸæ¬Šåˆ©äººæ‰€æœ‰ã€‚

æœ¬ç¶²ç«™ä¸ä¸»å¼µä»»ä½•é¡Œç›®å…§å®¹ä¹‹è‘—ä½œæ¬Šï¼Œ
äº¦ä¸æä¾›é¡Œåº«å…§å®¹ä¹‹è²©å”®ã€æ•£å¸ƒã€ä¸‹è¼‰æˆ–ä»»ä½•å½¢å¼ä¹‹å•†æ¥­åˆ©ç”¨ã€‚

æœ¬ç¤ºç¯„é é¢åƒ…é‡å°ä»‹é¢è¨­è¨ˆã€äº’å‹•æµç¨‹è¨­è¨ˆèˆ‡æ•™å­¸æ‡‰ç”¨æ–¹å¼é€²è¡Œå±•ç¤ºï¼Œ
ä¸ä»£è¡¨ä»»ä½•å®˜æ–¹ç«‹å ´ï¼Œäº¦ä¸æ§‹æˆä»»ä½•è€ƒè©¦çµæœæˆ–è­‰ç…§å–å¾—ä¹‹ä¿è­‰ã€‚

å¦‚åŸæ¬Šåˆ©äººå°æœ¬é å…§å®¹ä¹‹å‘ˆç¾æ–¹å¼æœ‰ä»»ä½•ç–‘æ…®ï¼Œ
è«‹è¯ç¹«å‘ŠçŸ¥ï¼Œæœ¬ç«™å°‡å³æ™‚é…åˆèª¿æ•´æˆ–ä¸‹æ¶ç›¸é—œå…§å®¹ã€‚

ä»‹é¢èˆ‡ç³»çµ±ç¤ºç¯„ï¼š
Force Chengï½œåŸåŠ›ç‹ è€å¸«
å¹´ä»½ï¼š2025 / 2026

--------------------------------------------------

English Version
ã€Copyright & Educational Use Noticeã€‘

This website is created solely for AI application planning,
educational demonstration, and testing purposes.

It is intended to showcase how publicly available exam questions
can be presented through different interface designs,
reading modes, and simulated examination workflows.

All question content displayed on this site originates from
officially published iPAS examination materials.
All copyrights and related rights belong to the original rights holders.

This website does not claim ownership of the question content,
nor does it provide redistribution, downloading,
or any form of commercial use of the materials.

The demonstration focuses exclusively on interface layout,
interaction flow, and educational application design,
and does not represent any official position
or guarantee any examination or certification outcome.

If the original rights holder has any concerns regarding the presentation
of the content on this site, please contact us,
and we will promptly make adjustments or remove the content as requested.

Interface & System Demonstration:
Force Cheng | Instructor â€œForce Foxâ€
Year: 2025 / 2026
            </div>
        </details>
    </div>
</footer>

<script>
// --- CONFIGURATION ---
const GOOGLE_SHEET_ID = "1yd94GHcO5WTGkShyKhud_yCYBzjoaOZtGlk3hWsvci8";
const CSV_URL = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/export?format=csv`;

// Global Data Container
let questions = [];

const app = {
    state: {
        mode: 'browse',
        browse: {
            fullList: [],
            currentList: [],
            renderedCount: 0,
            chunkSize: 10 // åˆ†æ‰¹æ¸²æŸ“ï¼š10 é¡Œ
        },
        exam: {
            list: [],
            currentIdx: 0,
            answers: [],
            scorePerQ: 0,
            userChoice: null,
            isSubmitted: false
        }
    },

    init: async function() {
        Papa.parse(CSV_URL, {
            download: true, header: true, skipEmptyLines: true,
            complete: (results) => {
                this.processData(results.data);
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                this.filterBrowseData(true);
            },
            error: (err) => {
                console.error(err);
                document.querySelector('#loading-overlay p').innerHTML = `<span style="color:red">é€£ç·šå¤±æ•—</span><br>ç„¡æ³•è®€å– Google Sheetã€‚<br>è«‹ç¢ºèªç¶²è·¯ç‹€æ…‹ã€‚`;
            }
        });
        
        // Add Global Keydown Listener
        document.addEventListener('keydown', (e) => this.handleKeydown(e));
    },

    processData: function(rawData) {
        questions = [];
        rawData.forEach((row, index) => {
            if (!row['ç·¨è™Ÿ'] && !row['id']) return;
            try {
                const id = row['ç·¨è™Ÿ'] || row['id'];
                let ansRaw = row['æ­£ç¢ºç­”æ¡ˆ'] || row['answer'];
                let ansIdx = -1;
                if (ansRaw) {
                    ansRaw = String(ansRaw).trim();
                    ansIdx = parseInt(ansRaw) - 1;
                }
                questions.push({
                    id: String(id).trim(),
                    subject: String(row['åˆ†é¡'] || row['subject'] || "").trim(),
                    qno: parseInt(row['é¡Œè™Ÿ'] || row['qno']) || 0,
                    filename: String(row['æ–‡ä»¶åç¨±'] || row['filename'] || "").trim(),
                    question: String(row['é¡Œç›®'] || row['question'] || "").trim(),
                    options: [
                        String(row['é¸é …1'] || row['opt1'] || "").trim(),
                        String(row['é¸é …2'] || row['opt2'] || "").trim(),
                        String(row['é¸é …3'] || row['opt3'] || "").trim(),
                        String(row['é¸é …4'] || row['opt4'] || "").trim()
                    ],
                    answerIndex: ansIdx
                });
            } catch (err) { console.warn(`Row ${index} format error`, err); }
        });
    },

    switchMode: function(mode) {
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('#app > div').forEach(el => el.classList.add('hidden'));

        if (mode === 'browse') {
            document.querySelector('.nav-item:nth-child(1)').classList.add('active');
            document.getElementById('view-browse').classList.remove('hidden');
        } else if (mode === 'setup') {
            document.querySelector('.nav-item:nth-child(2)').classList.add('active');
            document.getElementById('view-setup').classList.remove('hidden');
        } else if (mode === 'exam_running' || mode === 'result') {
            document.querySelector('.nav-item:nth-child(2)').classList.add('active');
            document.getElementById(mode === 'result' ? 'view-result' : 'view-exam').classList.remove('hidden');
        }
        this.state.mode = mode;
        window.scrollTo(0, 0);
    },

    // --- KEYBOARD SUPPORT ---
    handleKeydown: function(e) {
        if (this.state.mode !== 'exam_running') return;

        // 1-4 for options
        if (['1', '2', '3', '4'].includes(e.key)) {
            const idx = parseInt(e.key) - 1;
            const btn = document.querySelectorAll('#exam-options .option-btn')[idx];
            if (btn) this.selectOption(idx, btn);
        }

        // Enter for Submit / Next
        if (e.key === 'Enter') {
            const ex = this.state.exam;
            if (!ex.isSubmitted) {
                // Not submitted yet: try to submit if option selected
                if (ex.userChoice !== null) this.submitAnswer();
            } else {
                // Already submitted: go to next question or finish
                // Check if the feedback Next button is visible
                const nextBtn = document.querySelector('#exam-feedback button');
                if (nextBtn) nextBtn.click();
            }
        }
    },

    // --- BROWSE LOGIC ---
    filterBrowseData: function(reset = false) {
        const subject = document.getElementById('browse-subject').value;
        const order = document.getElementById('browse-order').value;
        let list = questions.filter(q => subject === 'ALL' || q.subject === subject);
        
        if (order === 'rand') list = this.shuffle([...list]); 
        else list.sort((a, b) => a.qno - b.qno);

        this.state.browse.currentList = list;
        document.getElementById('browse-count').innerText = `å…± ${list.length} é¡Œ`;

        if (reset) {
            this.state.browse.renderedCount = 0;
            document.getElementById('browse-list').innerHTML = '';
            this.renderBrowseChunk();
        }
    },

    renderBrowseChunk: function() {
        const { currentList, renderedCount, chunkSize } = this.state.browse;
        const container = document.getElementById('browse-list');
        const showAllAns = document.getElementById('browse-show-ans').checked;
        const btnLoadMore = document.getElementById('btn-load-more');

        // Toggle handling
        if (event && event.target && event.target.id === 'browse-show-ans') {
            container.innerHTML = '';
            this.appendItemsToBrowse(currentList.slice(0, Math.max(chunkSize, renderedCount)), showAllAns);
            return; 
        }

        const nextBatch = currentList.slice(renderedCount, renderedCount + chunkSize);
        this.appendItemsToBrowse(nextBatch, showAllAns);
        this.state.browse.renderedCount += nextBatch.length;

        if (this.state.browse.renderedCount < currentList.length) {
            btnLoadMore.classList.remove('hidden');
            btnLoadMore.innerText = `è¼‰å…¥æ›´å¤š... (å‰©é¤˜ ${currentList.length - this.state.browse.renderedCount} é¡Œ)`;
        } else {
            btnLoadMore.classList.add('hidden');
        }
    },

    appendItemsToBrowse: function(items, showAllAns) {
        const container = document.getElementById('browse-list');
        items.forEach((q, qIndex) => {
            const card = document.createElement('div');
            card.className = 'card';
            
            // Build options
            let optionsHtml = '';
            q.options.forEach((opt, idx) => {
                let classes = 'browse-opt';
                if (showAllAns && idx === q.answerIndex) classes += ' is-ans';
                optionsHtml += `<div class="${classes}" data-opt-idx="${idx}">${opt}</div>`;
            });

            const showBtnId = `btn-show-${q.id}-${Math.random().toString(36).substr(2,5)}`; 
            
            card.innerHTML = `
                <div class="card-header">
                    <div>
                        <span class="badge badge-subject">${q.subject}</span>
                        <span class="badge badge-id">${q.id}</span>
                    </div>
                    ${!showAllAns ? `<button id="${showBtnId}" class="btn btn-outline btn-sm" onclick="app.revealAnswer(this, ${q.answerIndex})">ğŸ‘ï¸ æŸ¥çœ‹ç­”æ¡ˆ</button>` : ''}
                </div>
                <div class="question-text"><span style="color:var(--google-blue);">Q${q.qno}.</span> ${q.question}</div>
                <div class="browse-opts-container">${optionsHtml}</div>
            `;
            container.appendChild(card);
        });
    },

    revealAnswer: function(btn, correctIdx) {
        const cardBody = btn.closest('.card').querySelector('.browse-opts-container');
        const opts = cardBody.querySelectorAll('.browse-opt');
        if(opts[correctIdx]) opts[correctIdx].classList.add('is-ans');
        btn.style.display = 'none';
    },

    // --- EXAM LOGIC ---
    startExam: function() {
        const subject = document.getElementById('exam-subject').value;
        const order = document.getElementById('exam-order').value;
        let limit = parseInt(document.getElementById('exam-limit').value);
        let list = questions.filter(q => subject === 'ALL' || q.subject === subject);
        
        if (list.length === 0) return alert("ç„¡é¡Œç›®å¯å‡º");
        if (limit > list.length) limit = list.length;
        if (order === 'rand') list = this.shuffle([...list]);
        else list.sort((a, b) => a.qno - b.qno);

        list = list.slice(0, limit);

        this.state.exam = {
            list: list,
            currentIdx: 0,
            answers: [],
            scorePerQ: 100 / list.length,
            userChoice: null,
            isSubmitted: false
        };

        const modeName = (subject === 'ALL' ? 'ç¶œåˆ' : subject);
        document.getElementById('exam-header-info').innerText = `${modeName} / ${limit}é¡Œ`;
        this.switchMode('exam_running');
        this.renderExamQuestion();
    },

    renderExamQuestion: function() {
        const ex = this.state.exam;
        const q = ex.list[ex.currentIdx];

        document.getElementById('exam-feedback').classList.add('hidden');
        const submitBtn = document.getElementById('exam-submit-btn');
        submitBtn.classList.remove('hidden');
        submitBtn.disabled = true;
        submitBtn.innerText = ex.currentIdx === ex.list.length - 1 ? "äº¤å·" : "é€å‡ºç­”æ¡ˆ";
        
        ex.userChoice = null;
        ex.isSubmitted = false;

        document.getElementById('exam-q-id').innerText = `ID: ${q.id}`;
        document.getElementById('exam-progress').innerText = `${ex.currentIdx + 1} / ${ex.list.length}`;
        document.getElementById('exam-score-info').innerText = `å¾—åˆ†: ${(ex.answers.filter(a=>a.isCorrect).length * ex.scorePerQ).toFixed(1)}`;
        document.getElementById('exam-q-text').innerHTML = `<span style="color:var(--google-blue);">Q${q.qno}.</span> ${q.question}`;

        const grid = document.getElementById('exam-options');
        grid.innerHTML = '';
        q.options.forEach((opt, idx) => {
            const btn = document.createElement('div');
            btn.className = 'option-btn';
            btn.innerText = opt;
            btn.onclick = () => app.selectOption(idx, btn);
            grid.appendChild(btn);
        });
    },

    selectOption: function(idx, btnElement) {
        if (this.state.exam.isSubmitted) return;
        this.state.exam.userChoice = idx;
        document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
        btnElement.classList.add('selected');
        document.getElementById('exam-submit-btn').disabled = false;
    },

    submitAnswer: function() {
        const ex = this.state.exam;
        if (ex.userChoice === null) return;
        ex.isSubmitted = true;
        
        const q = ex.list[ex.currentIdx];
        const isCorrect = (ex.userChoice === q.answerIndex);
        
        ex.answers.push({ 
            qData: q, 
            userChoice: ex.userChoice,
            isCorrect: isCorrect 
        });

        document.getElementById('exam-submit-btn').classList.add('hidden');
        document.getElementById('exam-feedback').classList.remove('hidden');
        
        const optBtns = document.querySelectorAll('.option-btn');
        optBtns[q.answerIndex].classList.add('correct');
        
        const fbPanel = document.getElementById('feedback-panel');
        const fbMsg = document.getElementById('feedback-msg');
        
        if (!isCorrect) {
            optBtns[ex.userChoice].classList.add('wrong');
            fbMsg.innerText = "ç­”éŒ¯äº†ï¼";
            fbMsg.style.color = "var(--google-red)";
            fbPanel.className = 'feedback-panel wrong';
            document.getElementById('feedback-detail').innerText = `æ­£ç¢ºç­”æ¡ˆï¼š${q.options[q.answerIndex]}`;
        } else {
            fbMsg.innerText = "ç­”å°äº†ï¼";
            fbMsg.style.color = "var(--google-green)";
            fbPanel.className = 'feedback-panel correct';
            document.getElementById('feedback-detail').innerText = "";
        }
        
        document.getElementById('feedback-source').innerText = `å‡ºè™•ï¼š${q.filename || 'æœªçŸ¥'}`;
        document.getElementById('exam-score-info').innerText = `å¾—åˆ†: ${(ex.answers.filter(a=>a.isCorrect).length * ex.scorePerQ).toFixed(1)}`;

        const nextBtn = document.querySelector('#exam-feedback button');
        if (ex.currentIdx === ex.list.length - 1) {
            nextBtn.innerText = "æŸ¥çœ‹çµæœ";
            nextBtn.onclick = () => app.finishExam();
        } else {
            nextBtn.innerText = "ä¸‹ä¸€é¡Œ";
            nextBtn.onclick = () => app.nextQuestion();
        }
    },

    nextQuestion: function() {
        this.state.exam.currentIdx++;
        this.renderExamQuestion();
        window.scrollTo(0,0);
    },

    finishExam: function() {
        const ex = this.state.exam;
        const total = ex.list.length;
        const correct = ex.answers.filter(a => a.isCorrect).length;
        const wrong = total - correct;
        
        document.getElementById('result-score').innerText = (correct * ex.scorePerQ).toFixed(0);
        document.getElementById('result-correct').innerText = correct;
        document.getElementById('result-wrong').innerText = wrong;
        
        // Render Review
        const reviewContainer = document.getElementById('review-list');
        const reviewSection = document.getElementById('review-section');
        reviewContainer.innerHTML = '';
        
        const wrongAnswers = ex.answers.filter(a => !a.isCorrect);
        
        if (wrongAnswers.length > 0) {
            reviewSection.classList.remove('hidden');
            wrongAnswers.forEach((item, idx) => {
                const q = item.qData;
                const card = document.createElement('div');
                card.className = 'review-card';
                
                let optsHtml = '';
                q.options.forEach((opt, optIdx) => {
                    let style = 'padding:8px; border-radius:4px; margin-bottom:4px; border:1px solid #eee;';
                    let prefix = '';
                    if (optIdx === q.answerIndex) {
                        style = 'background:#e6f4ea; border-color:var(--google-green); color:#0d652d; font-weight:bold;';
                        prefix = 'âœ… æ­£ç¢ºï¼š';
                    } else if (optIdx === item.userChoice) {
                        style = 'background:#fce8e6; border-color:var(--google-red); color:#c5221f; text-decoration:line-through;';
                        prefix = 'âŒ æ‚¨çš„é¸æ“‡ï¼š';
                    }
                    optsHtml += `<div style="${style}">${prefix}${opt}</div>`;
                });

                card.innerHTML = `
                    <div style="font-size:14px; color:#666; margin-bottom:8px;">${q.id} | ${q.subject}</div>
                    <div style="font-weight:bold; margin-bottom:12px;">${q.question}</div>
                    <div>${optsHtml}</div>
                    <div style="font-size:12px; color:#999; margin-top:12px; text-align:right;">ä¾†æºï¼š${q.filename}</div>
                `;
                reviewContainer.appendChild(card);
            });
        } else {
            reviewSection.classList.add('hidden');
        }

        this.switchMode('result');
    },

    downloadMistakesCSV: function() {
        const ex = this.state.exam;
        const wrongAnswers = ex.answers.filter(a => !a.isCorrect);
        
        if (wrongAnswers.length === 0) {
            alert("æœ¬æ¬¡æ¸¬é©—æ²’æœ‰éŒ¯é¡Œï¼Œå¤ªæ£’äº†ï¼");
            return;
        }

        let csvContent = "\uFEFF"; 
        csvContent += "ç·¨è™Ÿ(ID),é¡Œç›®,é¸é …1,é¸é …2,é¸é …3,é¸é …4,æ­£ç¢ºç­”æ¡ˆ(1-4),ä½¿ç”¨è€…é¸é …(1-4),ä¾†æºæª”å\n";

        wrongAnswers.forEach(item => {
            const q = item.qData;
            const safeStr = (str) => `"${String(str).replace(/"/g, '""')}"`;
            
            const row = [
                safeStr(q.id),
                safeStr(q.question),
                safeStr(q.options[0] || ""),
                safeStr(q.options[1] || ""),
                safeStr(q.options[2] || ""),
                safeStr(q.options[3] || ""),
                safeStr(q.answerIndex + 1),
                safeStr(item.userChoice + 1),
                safeStr(q.filename)
            ];
            csvContent += row.join(",") + "\n";
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", `review_mistakes_${new Date().toISOString().slice(0,10)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    },

    printResults: function() {
        // Set temp title for PDF filename
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        const oldTitle = document.title;
        
        document.title = `iPAS_AIæ‡‰ç”¨è¦åŠƒå¸«_æ¨¡æ“¬æ¸¬è©¦-${yyyy}å¹´${mm}æœˆ${dd}æ—¥`;
        
        window.print();
        
        // Restore title (optional, browser handles this quickly usually)
        setTimeout(() => { document.title = oldTitle; }, 1000);
    },

    shuffle: function(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    }
};

window.onload = app.init.bind(app);
</script>
</body>
</html>